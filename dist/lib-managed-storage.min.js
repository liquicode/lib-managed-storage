!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["lib-managed-storage"]=t():e["lib-managed-storage"]=t()}("undefined"!=typeof self?self:this,(function(){return(()=>{"use strict";var e={339:(e,t,n)=>{const r=n(747),i=n(622);n(294);const a=n(487),o=n(231),s=n(973),l=n(585),{stringify:u}=n(191);t.NewJsonProvider=function(e={}){let t={},n=[],u="",_=!1;async function c(){return new Promise((async(e,t)=>{try{if(_){let e=u+".lock",i={stale:15e3,retries:1e3};try{s.lockSync(e,i),r.writeFileSync(u,JSON.stringify(n,null,"\t"))}catch(e){t(e)}finally{s.unlockSync(e)}}_=!1,e()}catch(e){t(e)}}))}return!l.value_missing_null_empty(e.database_name)&&!l.value_missing_null_empty(e.collection_name)&&(e.database_name=i.resolve(e.database_name),r.existsSync(e.database_name)||r.mkdirSync(e.database_name,{recursive:!0}),u=i.join(e.database_name,e.collection_name),u.toLowerCase().endsWith(".json")||(u+=".json"),e.clear_collection_on_start&&r.existsSync(u)&&r.unlinkSync(u),r.existsSync(u)&&(n=JSON.parse(r.readFileSync(u,"utf8")),Array.isArray(n)||(n=[n])),e.flush_every_ms&&e.flush_every_ms>0)&&setInterval((()=>c()),e.flush_every_ms).unref(),t.Flush=c,t.Count=async function(e){return new Promise((async(t,r)=>{try{let r=0;if(l.value_missing_null_empty(e))r=n.length;else for(let t=0;t<n.length;t++){let i=n[t];a.test(i,e)&&r++}t(r)}catch(e){r(e)}}))},t.FindOne=async function(e){return new Promise((async(t,r)=>{try{let r=null;if(l.value_missing_null_empty(e))n.length>0&&(r=l.clone(n[0]));else for(let t=0;t<n.length;t++){let i=n[t];if(a.test(i,e)){r=l.clone(i);break}}t(r)}catch(e){r(e)}}))},t.FindMany=async function(e){return new Promise((async(t,r)=>{try{let r=[];for(let t=0;t<n.length;t++){let i=n[t];(l.value_missing_null_empty(e)||a.test(i,e))&&r.push(l.clone(i))}t(r)}catch(e){r(e)}}))},t.CreateOne=async function(t){return new Promise((async(r,i)=>{try{t._id=o.v4();let i=l.clone(t);n.push(i),_=!0,e.flush_on_update&&await c(),r(l.clone(i))}catch(e){i(e)}}))},t.WriteOne=async function(t,r){return new Promise((async(i,o)=>{try{if(l.value_missing_null_empty(r)){if(l.value_missing_null_empty(t._id))throw new Error("You must supply either [Criteria] or [DataObject._id] in the parameters.");r={_id:t._id}}for(let o=0;o<n.length;o++){let s=n[o];if(a.test(s,r))return n[o]=l.merge_objects(s,t),_=!0,e.flush_on_update&&await c(),void i(1)}i(0)}catch(e){o(e)}}))},t.DeleteOne=async function(t){return new Promise((async(r,i)=>{try{let i=0;if(l.value_missing_null_empty(t))n.length>0&&(n.splice(0,1),i++);else for(let e=0;e<n.length;e++){let r=n[e];if(a.test(r,t)){n.splice(e,1),i++;break}}i>0&&(_=!0,e.flush_on_update&&await c()),r(i)}catch(e){i(e)}}))},t.DeleteMany=async function(t){return new Promise((async(r,i)=>{try{let i=0;if(l.value_missing_null_empty(t))i=n.length,n=[];else for(let e=n.length-1;e>=0;e--){let r=n[e];a.test(r,t)&&(n.splice(e,1),i++)}i>0&&(_=!0,e.flush_on_update&&await c()),r(i)}catch(e){i(e)}}))},t}},776:(e,t,n)=>{const r=n(548),i=n(585);t.NewMongoProvider=function(e){let t={};async function n(t){let n=null,i=null;try{if(i=await r.MongoClient.connect(e.connection_string,{keepAlive:!0,useUnifiedTopology:!0,useNewUrlParser:!0}),!i)throw new Error("Unable to establish a connection to the mongodb database server.");n=i.db(e.database_name);let a=n.collection(e.collection_name);return await t(a)}catch(e){throw e}finally{i&&i.close()}}return t.WithStorage=n,t.Flush=async function(){return new Promise((async(e,t)=>{e()}))},t.Count=async function(e){return await n((async function(t){return await t.countDocuments(e)}))},t.FindOne=async function(e){return await n((async function(t){return await t.findOne(e)}))},t.FindMany=async function(e){return await n((async function(t){let n=await t.find(e);if(!n)throw new Error("Unable to obtain a cursor on the collection.");return await n.toArray()}))},t.CreateOne=async function(e){return await n((async function(t){if(!(await t.insertOne(e)).acknowledged)throw new Error("Database did not acknowledge insertion.");let n=i.clone(e);return n._id=e._id,n}))},t.WriteOne=async function(e,t){return await n((async function(n){i.value_missing_null_empty(t)&&(t={_id:e._id});let r=i.clone(e);delete r._id;let a=await n.replaceOne(t,r);if(!a.acknowledged)throw new Error("Database did not acknowledge insertion.");return a.modifiedCount}))},t.DeleteOne=async function(e){return await n((async function(t){let n=await t.deleteOne(e);if(!n.acknowledged)throw new Error("Database did not acknowledge deletion.");return n.deletedCount}))},t.DeleteMany=async function(e){return await n((async function(t){let n=await t.deleteMany(e);if(!n.acknowledged)throw new Error("Database did not acknowledge deletion.");return n.deletedCount}))},t}},585:(e,t)=>{function n(e){if(null===e)return!0;switch(typeof e){case"undefined":return!0;case"string":if(0===e.length)return!0;case"object":if(null===e)return!0;if(0===Object.keys(e).length)return!0}return!1}t.value_missing_null_empty=n,t.value_missing=function(e){return null==e},t.value_exists=function(e){return!n(e)},t.MISSING_PARAMETER_ERROR=function(e){return new Error(`Required parameter is missing: ${e}`)},t.READ_ACCESS_ERROR=function(){return new Error("User does not have read access to this object or the object does not exist.")},t.WRITE_ACCESS_ERROR=function(){return new Error("User does not have write access to this object.")},t.clone=function(e){return JSON.parse(JSON.stringify(e))},t.merge_objects=function(e,t){let n=JSON.parse(JSON.stringify(e));return function e(t,n){Object.keys(n).forEach((r=>{let i=n[r];void 0===t[r]?t[r]=JSON.parse(JSON.stringify(i)):"object"==typeof i?e(t[r],i):t[r]=JSON.parse(JSON.stringify(i))}))}(n,t),n},t.zulu_timestamp=function(){return(new Date).toISOString()}},294:e=>{e.exports=require("babel-polyfill")},747:e=>{e.exports=require("fs")},487:e=>{e.exports=require("json-criteria")},973:e=>{e.exports=require("lockfile")},548:e=>{e.exports=require("mongodb")},622:e=>{e.exports=require("path")},191:e=>{e.exports=require("querystring")},231:e=>{e.exports=require("uuid")}},t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={exports:{}};return e[r](i,i.exports,n),i.exports}var r={};return(()=>{var e=r;const t=n(231),i=n(585),a=n(776),o=n(339),s={DefaultConfiguration:function(){return{throw_permission_errors:!1,mongo_provider:{enabled:!1,collection_name:"Collection-Name",database_name:"Database-Name",connection_string:"mongodb://<username>:<password>@<server-address"},json_provider:{enabled:!1,collection_name:"Collection-Name",database_name:"/path/to/store/collections",clear_collection_on_start:!1,flush_on_update:!1,flush_every_ms:0}}}};e.DefaultConfiguration=s.DefaultConfiguration,s.StorageAdministrator=function(){return{name:"Storage Administrator",user_id:"admin@storage",user_role:"admin"}},e.StorageAdministrator=s.StorageAdministrator,s.NewManagedObject=function(e,n){if(!i.value_exists(e))throw i.MISSING_PARAMETER_ERROR("Owner");if(!i.value_exists(e.user_id))throw i.MISSING_PARAMETER_ERROR("Owner.user_id");return{_m:{id:t.v4(),created_at:i.zulu_timestamp(),updated_at:i.zulu_timestamp(),owner_id:e.user_id,readers:[],writers:[],public:!1},_o:i.clone(n)}},e.NewManagedObject=s.NewManagedObject,s.NewManagedStorage=function(e={}){let t={},n=null;function r(e){if(i.value_missing_null_empty(e))throw i.MISSING_PARAMETER_ERROR("User");if(i.value_missing_null_empty(e.user_id))throw i.MISSING_PARAMETER_ERROR("User.user_id");if(i.value_missing_null_empty(e.user_role))throw i.MISSING_PARAMETER_ERROR("User.user_role");if(!["admin","super","user"].includes(e.user_role))throw new Error(`Unknown value for User.user_role: [${e.user_role}]`)}function l(e,t){if(r(e),function(e){if(i.value_missing_null_empty(e))throw i.MISSING_PARAMETER_ERROR("ManagedObject");if(i.value_missing_null_empty(e._m))throw i.MISSING_PARAMETER_ERROR("ManagedObject._m");if(i.value_missing_null_empty(e._m.id))throw i.MISSING_PARAMETER_ERROR("ManagedObject._m.id");if(i.value_missing_null_empty(e._m.owner_id))throw i.MISSING_PARAMETER_ERROR("ManagedObject._m.owner_id");if(i.value_missing(e._m.readers))throw i.MISSING_PARAMETER_ERROR("ManagedObject._m.readers");if(i.value_missing(e._m.writers))throw i.MISSING_PARAMETER_ERROR("ManagedObject._m.writers");if(i.value_missing(e._m.public))throw i.MISSING_PARAMETER_ERROR("ManagedObject._m.public")}(t),"admin"===e.user_role)return!0;if("super"===e.user_role)return!0;if("user"===e.user_role){if(e.user_id===t._m.owner_id)return!0;if(t._m.writers.includes(e.user_id))return!0}return!1}function u(e,t){r(e);let n={},a=typeof t;if("string"===a)n._m={id:t};else if("object"===a)null===t||(i.value_missing_null_empty(t._m)||i.value_missing_null_empty(t._m.id)?i.value_missing_null_empty(t._o)?Object.keys(t).length>0&&(n._o=i.clone(t),delete n._o._m):Object.keys(t._o).length>0&&(n._o=i.clone(t._o)):n._m={id:t._m.id});else if("undefined"!==a)throw new Error(`Unknown parameter type [${a}] for [ObjectOrID]. Must be a string, object, null, or undefined.`);return"user"===e.user_role&&(n.$or=[],n.$or.push({"_m.owner_id":e.user_id}),n.$or.push({"_m.readers":{$in:e.user_id}}),n.$or.push({"_m.writers":{$in:e.user_id}}),n.$or.push({"_m.public":!0})),n}return n=e.mongo_provider&&e.mongo_provider.enabled?a.NewMongoProvider(e.mongo_provider):e.json_provider&&e.json_provider.enabled?o.NewJsonProvider(e.json_provider):o.NewJsonProvider(),t.Count=async function(e,t){try{let r=u(e,t);return await n.Count(r)}catch(e){throw e}},t.FindOne=async function(e,t){try{let r=u(e,t),i=await n.FindOne(r);return i&&delete i._id,i}catch(e){throw e}},t.FindMany=async function(e,t){try{let r=u(e,t),i=await n.FindMany(r);return i.forEach((e=>{delete e._id})),i}catch(e){throw e}},t.CreateOne=async function(e,t){try{let r=s.NewManagedObject(e,t),i=await n.CreateOne(r);return i&&delete i._id,i}catch(e){throw e}},t.WriteOne=async function(t,r,a){try{let o=u(t,r),s=await n.FindOne(o);if(!s){if(e.throw_permission_errors)throw i.READ_ACCESS_ERROR();return 0}if(!l(t,s)){if(e.throw_permission_errors)throw i.WRITE_ACCESS_ERROR();return 0}return i.value_missing_null_empty(a._o)||(a=a._o),s._m.updated_at=i.zulu_timestamp(),s._o=i.merge_objects(s._o,a),await n.WriteOne(s)}catch(e){throw e}},t.DeleteOne=async function(t,r){try{let a=u(t,r),o=await n.FindOne(a);if(!o){if(e.throw_permission_errors)throw i.READ_ACCESS_ERROR();return 0}if(!l(t,o)){if(e.throw_permission_errors)throw i.WRITE_ACCESS_ERROR();return 0}return await n.DeleteOne(u(t,o))}catch(e){throw e}},t.DeleteMany=async function(e,t){try{let r=u(e,t),i=0,a=await n.FindMany(r);for(let t=0;t<a.length;t++){let r=a[t];if(l(e,r)){if(!await n.DeleteOne(u(e,r)))throw new Error("There was an unexpected problem deleting the object.");i++}}return i}catch(e){throw e}},t.SetOwner=async function(e,t){try{let r=u(e,t),a=0,o=await n.FindMany(r);for(let t=0;t<o.length;t++){let r=o[t];l(e,r)&&(r._m.owner_id=e.user_id,r._m.updated_at=i.zulu_timestamp(),a+=await n.WriteOne(r))}return a}catch(e){throw e}},t.Share=async function(e,t,r,a,o){try{let s=u(e,t),_=0,c=await n.FindMany(s);for(let t=0;t<c.length;t++){let s=c[t];if(l(e,s)){let e=!1;if(!i.value_missing_null_empty(r)){let t=[];if("string"==typeof r)t.push(r);else{if(!Array.isArray(r))throw new Error("Invalid value for parameter [Readers], must be a string or array of strings.");t=r}t.forEach((t=>{s._m.readers.includes(t)||(s._m.readers.push(t),e=!0)}))}if(!i.value_missing_null_empty(a)){let t=[];if("string"==typeof a)t.push(a);else{if(!Array.isArray(a))throw new Error("Invalid value for parameter [Readers], must be a string or array of strings.");t=a}t.forEach((t=>{s._m.writers.includes(t)||(s._m.writers.push(t),e=!0)}))}!i.value_missing_null_empty(o)&&o&&(s._m.public||(s._m.public=!0,e=!0)),e&&(s._m.updated_at=i.zulu_timestamp(),_+=await n.WriteOne(s))}}return _}catch(e){throw e}},t.Unshare=async function(e,t,r,a,o){try{let s=u(e,t),_=0,c=await n.FindMany(s);for(let t=0;t<c.length;t++){let s=c[t];if(l(e,s)){let e=!1;if(!i.value_missing_null_empty(r)){let t=[];if("string"==typeof r)t.push(r);else{if(!Array.isArray(Readers))throw new Error("Invalid value for parameter [Readers], must be a string or array of strings.");t=r}t.forEach((t=>{let n=s._m.readers.indexOf(t);n>=0&&(s._m.readers.slice(n,1),e=!0)}))}if(!i.value_missing_null_empty(a)){let t=[];if("string"==typeof a)t.push(a);else{if(!Array.isArray(a))throw new Error("Invalid value for parameter [Readers], must be a string or array of strings.");t=a}t.forEach((t=>{let n=s._m.writers.indexOf(t);n>=0&&(s._m.writers.slice(n,1),e=!0)}))}!i.value_missing_null_empty(o)&&o&&s._m.public&&(s._m.public=!1,e=!0),e&&(s._m.updated_at=i.zulu_timestamp(),_+=await n.WriteOne(s))}}return _}catch(e){throw e}},t},e.NewManagedStorage=s.NewManagedStorage})(),r})()}));