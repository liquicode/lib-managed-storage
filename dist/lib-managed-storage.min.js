!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["lib-managed-storage"]=t():e["lib-managed-storage"]=t()}("undefined"!=typeof self?self:this,(function(){return(()=>{"use strict";var e={339:(e,t,r)=>{const n=r(747),i=r(622);r(294);const a=r(487),s=r(231),o=r(973),l=r(585),{stringify:u}=r(191);t.NewJsonProvider=function(e={}){let t={},r=[],u="",_=!1;async function c(){return new Promise((async(e,t)=>{try{if(_){let e=u+".lock",i={stale:15e3,retries:1e3};try{o.lockSync(e,i),n.writeFileSync(u,JSON.stringify(r,null,"\t"))}catch(e){t(e)}finally{o.unlockSync(e)}}_=!1,e()}catch(e){t(e)}}))}return!l.value_missing_null_empty(e.database_name)&&!l.value_missing_null_empty(e.collection_name)&&(e.database_name=i.resolve(e.database_name),n.existsSync(e.database_name)||n.mkdirSync(e.database_name,{recursive:!0}),u=i.join(e.database_name,e.collection_name),u.toLowerCase().endsWith(".json")||(u+=".json"),e.clear_collection_on_start&&n.existsSync(u)&&n.unlinkSync(u),n.existsSync(u)&&(r=JSON.parse(n.readFileSync(u,"utf8")),Array.isArray(r)||(r=[r])),e.flush_every_ms&&e.flush_every_ms>0)&&setInterval((()=>c()),e.flush_every_ms).unref(),t.Flush=c,t.Count=async function(e){return new Promise((async(t,n)=>{try{let n=0;if(l.value_missing_null_empty(e))n=r.length;else for(let t=0;t<r.length;t++){let i=r[t];a.test(i,e)&&n++}t(n)}catch(e){n(e)}}))},t.FindOne=async function(e){return new Promise((async(t,n)=>{try{let n=null;if(l.value_missing_null_empty(e))r.length>0&&(n=l.clone(r[0]));else for(let t=0;t<r.length;t++){let i=r[t];if(a.test(i,e)){n=l.clone(i);break}}t(n)}catch(e){n(e)}}))},t.FindMany=async function(e){return new Promise((async(t,n)=>{try{let n=[];for(let t=0;t<r.length;t++){let i=r[t];(l.value_missing_null_empty(e)||a.test(i,e))&&n.push(l.clone(i))}t(n)}catch(e){n(e)}}))},t.CreateOne=async function(t){return new Promise((async(n,i)=>{try{t._id=s.v4();let i=l.clone(t);r.push(i),_=!0,e.flush_on_update&&await c(),n(l.clone(i))}catch(e){i(e)}}))},t.WriteOne=async function(t,n){return new Promise((async(i,s)=>{try{if(l.value_missing_null_empty(n)){if(l.value_missing_null_empty(t._id))throw new Error("You must supply either [Criteria] or [DataObject._id] in the parameters.");n={_id:t._id}}for(let s=0;s<r.length;s++){let o=r[s];if(a.test(o,n))return r[s]=l.merge_objects(o,t),_=!0,e.flush_on_update&&await c(),void i(1)}i(0)}catch(e){s(e)}}))},t.DeleteOne=async function(t){return new Promise((async(n,i)=>{try{let i=0;if(l.value_missing_null_empty(t))r.length>0&&(r.splice(0,1),i++);else for(let e=0;e<r.length;e++){let n=r[e];if(a.test(n,t)){r.splice(e,1),i++;break}}i>0&&(_=!0,e.flush_on_update&&await c()),n(i)}catch(e){i(e)}}))},t.DeleteMany=async function(t){return new Promise((async(n,i)=>{try{let i=0;if(l.value_missing_null_empty(t))i=r.length,r=[];else for(let e=r.length-1;e>=0;e--){let n=r[e];a.test(n,t)&&(r.splice(e,1),i++)}i>0&&(_=!0,e.flush_on_update&&await c()),n(i)}catch(e){i(e)}}))},t}},776:(e,t,r)=>{const n=r(548),i=r(585);t.NewMongoDbProvider=function(e){let t={};async function r(t){let r=null,i=null;try{if(i=await n.MongoClient.connect(e.connection_string,{keepAlive:!0,useUnifiedTopology:!0,useNewUrlParser:!0}),!i)throw new Error("Unable to establish a connection to the mongodb database server.");r=i.db(e.database_name);let a=r.collection(e.collection_name);return await t(a)}catch(e){throw e}finally{i&&i.close()}}return t.WithStorage=r,t.Flush=async function(){return new Promise((async(e,t)=>{e()}))},t.Count=async function(e){return await r((async function(t){return await t.countDocuments(e)}))},t.FindOne=async function(e){return await r((async function(t){return await t.findOne(e)}))},t.FindMany=async function(e){return await r((async function(t){let r=await t.find(e);if(!r)throw new Error("Unable to obtain a cursor on the collection.");return await r.toArray()}))},t.CreateOne=async function(e){return await r((async function(t){if(!(await t.insertOne(e)).acknowledged)throw new Error("Database did not acknowledge insertion.");let r=i.clone(e);return r._id=e._id,r}))},t.WriteOne=async function(e,t){return await r((async function(r){i.value_missing_null_empty(t)&&(t={_id:e._id});let n=i.clone(e);delete n._id;let a=await r.replaceOne(t,n);if(!a.acknowledged)throw new Error("Database did not acknowledge insertion.");return a.modifiedCount}))},t.DeleteOne=async function(e){return await r((async function(t){let r=await t.deleteOne(e);if(!r.acknowledged)throw new Error("Database did not acknowledge deletion.");return r.deletedCount}))},t.DeleteMany=async function(e){return await r((async function(t){let r=await t.deleteMany(e);if(!r.acknowledged)throw new Error("Database did not acknowledge deletion.");return r.deletedCount}))},t}},585:(e,t)=>{function r(e){if(null===e)return!0;switch(typeof e){case"undefined":return!0;case"string":if(0===e.length)return!0;case"object":if(null===e)return!0;if(0===Object.keys(e).length)return!0}return!1}t.value_missing_null_empty=r,t.value_missing=function(e){return null==e},t.value_exists=function(e){return!r(e)},t.MISSING_PARAMETER_ERROR=function(e){return new Error(`Required parameter is missing: ${e}`)},t.READ_ACCESS_ERROR=function(){return new Error("User does not have read access to this object or the object does not exist.")},t.WRITE_ACCESS_ERROR=function(){return new Error("User does not have write access to this object.")},t.clone=function(e){return JSON.parse(JSON.stringify(e))},t.merge_objects=function(e,t){let r=JSON.parse(JSON.stringify(e));return function e(t,r){Object.keys(r).forEach((n=>{let i=r[n];void 0===t[n]?t[n]=JSON.parse(JSON.stringify(i)):"object"==typeof i?e(t[n],i):t[n]=JSON.parse(JSON.stringify(i))}))}(r,t),r},t.zulu_timestamp=function(){return(new Date).toISOString()}},294:e=>{e.exports=require("babel-polyfill")},747:e=>{e.exports=require("fs")},487:e=>{e.exports=require("json-criteria")},973:e=>{e.exports=require("lockfile")},548:e=>{e.exports=require("mongodb")},622:e=>{e.exports=require("path")},191:e=>{e.exports=require("querystring")},231:e=>{e.exports=require("uuid")}},t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={exports:{}};return e[n](i,i.exports,r),i.exports}var n={};return(()=>{var e=n;const t=r(231),i=r(585),a=r(776),s=r(339);e.DefaultConfiguration=function(){return{throw_permission_errors:!1,provider:{mongodb:{enabled:!1,collection_name:"Collection-Name",database_name:"Database-Name",connection_string:"mongodb://<username>:<password>@<server-address"},json:{enabled:!1,collection_name:"Collection-Name",database_name:"/path/to/store/collections",flush_on_update:!1,flush_every_ms:0}},object:{title:"Object",titles:"Objects",fields:[]}}},e.NewManagedStorage=function(e={}){let r={},n=null;function o(e){if(i.value_missing_null_empty(e))throw i.MISSING_PARAMETER_ERROR("User");if(i.value_missing_null_empty(e.user_id))throw i.MISSING_PARAMETER_ERROR("User.user_id");if(i.value_missing_null_empty(e.user_role))throw i.MISSING_PARAMETER_ERROR("User.user_role");if(!["admin","super","user"].includes(e.user_role))throw new Error(`Unknown value for User.user_role: [${e.user_role}]`)}function l(e){if(i.value_missing_null_empty(e))throw i.MISSING_PARAMETER_ERROR("ManagedObject");if(i.value_missing_null_empty(e._m))throw i.MISSING_PARAMETER_ERROR("ManagedObject._m");if(i.value_missing_null_empty(e._m.owner_id))throw i.MISSING_PARAMETER_ERROR("ManagedObject._m.owner_id");if(i.value_missing(e._m.readers))throw i.MISSING_PARAMETER_ERROR("ManagedObject._m.readers");if(i.value_missing(e._m.writers))throw i.MISSING_PARAMETER_ERROR("ManagedObject._m.writers");if(i.value_missing(e._m.public))throw i.MISSING_PARAMETER_ERROR("ManagedObject._m.public")}function u(e,t){if(o(e),l(t),"admin"===e.user_role)return!0;if("super"===e.user_role)return!0;if("user"===e.user_role){if(e.user_id===t._m.owner_id)return!0;if(t._m.writers.includes(e.user_id))return!0}return!1}function _(e,t,r){o(e);let n={};return i.value_missing_null_empty(r)||(n._m={id:r}),i.value_missing_null_empty(t)||(n._o=i.clone(t)),"user"===e.user_role&&(n.$or=[],n.$or.push({"_m.owner_id":e.user_id}),n.$or.push({"_m.readers":{$in:e.user_id}}),n.$or.push({"_m.writers":{$in:e.user_id}}),n.$or.push({"_m.public":!0})),n}function c(e){return l(e),{_m:{id:e._m.id}}}return n=e.mongodb&&e.mongodb.enabled?a.NewMongoProvider(e.mongodb):e.memory&&e.memory.enabled?s.NewJsonProvider(e.memory):s.NewJsonProvider(),r.Count=async function(e,t){try{let r=_(e,t,null);return await n.Count(r)}catch(e){throw e}},r.FindOne=async function(e,t){try{let r=null;r="string"==typeof ManagedObjectOrID?c({_m:{id:t}}):_(e,t,null);let i=await n.FindOne(r);return i&&delete i._id,i}catch(e){throw e}},r.FindMany=async function(e,t){try{let r=_(e,t,null),i=await n.FindMany(r);return i.forEach((e=>{delete e._id})),i}catch(e){throw e}},r.CreateOne=async function(e,r){try{let a={_m:{id:t.v4(),created_at:i.zulu_timestamp(),updated_at:i.zulu_timestamp(),owner_id:e.user_id,readers:[],writers:[],public:!1},_o:i.clone(r)},s=await n.CreateOne(a);return s&&delete s._id,s}catch(e){throw e}},r.WriteOne=async function(t,r){try{l(r);let a=_(t,null,r._m.id),s=await n.FindOne(a);if(!s){if(e.throw_permission_errors)throw i.READ_ACCESS_ERROR();return 0}if(!u(t,s)){if(e.throw_permission_errors)throw i.WRITE_ACCESS_ERROR();return 0}return s._m.updated_at=i.zulu_timestamp(),s._o=i.merge_objects(s._o,r._o),await n.WriteOne(s)}catch(e){throw e}},r.DeleteOne=async function(t,r){try{let a=null;a="string"==typeof ManagedObjectOrID?c({_m:{id:r}}):_(t,Criteria,null);let s=await n.FindOne(a);if(!s){if(e.throw_permission_errors)throw i.READ_ACCESS_ERROR();return 0}if(!u(t,s)){if(e.throw_permission_errors)throw i.WRITE_ACCESS_ERROR();return 0}return await n.DeleteOne(c(s))}catch(e){throw e}},r.DeleteMany=async function(e,t){try{let r=_(e,t,null),i=await n.FindMany(r),a=0;for(let t=0;t<i.length;t++){let r=i[t];if(u(e,r)){if(!await n.DeleteOne(c(r)))throw new Error("There was an unexpected problem deleting the object.");a++}}return a}catch(e){throw e}},r.Share=async function(t,r,a,s,o){try{let f=null;"string"==typeof r?f=c({_m:{id:r}}):(l(r),f=_(t,null,r._m.id));let d=await n.FindOne(f);if(!d){if(e.throw_permission_errors)throw i.READ_ACCESS_ERROR();return 0}if(!u(t,d)){if(e.throw_permission_errors)throw i.WRITE_ACCESS_ERROR();return 0}let m=!1;if(!i.value_missing_null_empty(a)){let e=[];if("string"==typeof a)e.push(a);else{if(!Array.isArray(a))throw new Error("Invalid value for parameter [Readers], must be a string or array of strings.");e=a}e.forEach((e=>{d._m.readers.includes(e)||(d._m.readers.push(e),m=!0)}))}if(!i.value_missing_null_empty(s)){let e=[];if("string"==typeof s)e.push(s);else{if(!Array.isArray(s))throw new Error("Invalid value for parameter [Readers], must be a string or array of strings.");e=s}e.forEach((e=>{d._m.writers.includes(e)||(d._m.writers.push(e),m=!0)}))}return!i.value_missing_null_empty(o)&&o&&(d._m.public||(d._m.public=!0,m=!0)),m?(d._m.updated_at=i.zulu_timestamp(),await n.WriteOne(d)):1}catch(e){throw e}},r.Unshare=async function(t,r,a,s,o){try{let f=null;"string"==typeof r?f=c({_m:{id:r}}):(l(r),f=_(t,null,r._m.id));let d=await n.FindOne(f);if(!d){if(e.throw_permission_errors)throw i.READ_ACCESS_ERROR();return 0}if(!u(t,d)){if(e.throw_permission_errors)throw i.WRITE_ACCESS_ERROR();return 0}let m=!1;if(!i.value_missing_null_empty(a)){let e=[];if("string"==typeof a)e.push(a);else{if(!Array.isArray(Readers))throw new Error("Invalid value for parameter [Readers], must be a string or array of strings.");e=a}e.forEach((e=>{let t=d._m.readers.indexOf(e);t>=0&&(d._m.readers.slice(t,1),m=!0)}))}if(!i.value_missing_null_empty(s)){let e=[];if("string"==typeof s)e.push(s);else{if(!Array.isArray(s))throw new Error("Invalid value for parameter [Readers], must be a string or array of strings.");e=s}e.forEach((e=>{let t=d._m.writers.indexOf(e);t>=0&&(d._m.writers.slice(t,1),m=!0)}))}return!i.value_missing_null_empty(o)&&o&&d._m.public&&(d._m.public=!1,m=!0),m?(d._m.updated_at=i.zulu_timestamp(),await n.WriteOne(d)):1}catch(e){throw e}},r}})(),n})()}));