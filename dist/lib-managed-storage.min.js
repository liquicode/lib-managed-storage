!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["lib-managed-storage"]=t():e["lib-managed-storage"]=t()}("undefined"!=typeof self?self:this,(function(){return(()=>{"use strict";var e={339:(e,t,n)=>{const r=n(747),i=n(622);n(294);const a=n(487),s=n(231),o=n(973),l=n(585),{stringify:u}=n(191);t.NewJsonProvider=function(e={}){let t={},n=[],u="",_=!1;async function c(){return new Promise((async(e,t)=>{try{if(_){let e=u+".lock",i={stale:15e3,retries:1e3};try{o.lockSync(e,i),r.writeFileSync(u,JSON.stringify(n,null,"\t"))}catch(e){t(e)}finally{o.unlockSync(e)}}_=!1,e()}catch(e){t(e)}}))}return!l.value_missing_null_empty(e.database_name)&&!l.value_missing_null_empty(e.collection_name)&&(e.database_name=i.resolve(e.database_name),r.existsSync(e.database_name)||r.mkdirSync(e.database_name,{recursive:!0}),u=i.join(e.database_name,e.collection_name),u.toLowerCase().endsWith(".json")||(u+=".json"),e.clear_collection_on_start&&r.existsSync(u)&&r.unlinkSync(u),r.existsSync(u)&&(n=JSON.parse(r.readFileSync(u,"utf8")),Array.isArray(n)||(n=[n])),e.flush_every_ms&&e.flush_every_ms>0)&&setInterval((()=>c()),e.flush_every_ms).unref(),t.Flush=c,t.Count=async function(e){return new Promise((async(t,r)=>{try{let r=0;if(l.value_missing_null_empty(e))r=n.length;else for(let t=0;t<n.length;t++){let i=n[t];a.test(i,e)&&r++}t(r)}catch(e){r(e)}}))},t.FindOne=async function(e){return new Promise((async(t,r)=>{try{let r=null;if(l.value_missing_null_empty(e))n.length>0&&(r=l.clone(n[0]));else for(let t=0;t<n.length;t++){let i=n[t];if(a.test(i,e)){r=l.clone(i);break}}t(r)}catch(e){r(e)}}))},t.FindMany=async function(e){return new Promise((async(t,r)=>{try{let r=[];for(let t=0;t<n.length;t++){let i=n[t];(l.value_missing_null_empty(e)||a.test(i,e))&&r.push(l.clone(i))}t(r)}catch(e){r(e)}}))},t.CreateOne=async function(t){return new Promise((async(r,i)=>{try{t._id=s.v4();let i=l.clone(t);n.push(i),_=!0,e.flush_on_update&&await c(),r(l.clone(i))}catch(e){i(e)}}))},t.WriteOne=async function(t,r){return new Promise((async(i,s)=>{try{if(l.value_missing_null_empty(r)){if(l.value_missing_null_empty(t._id))throw new Error("You must supply either [Criteria] or [DataObject._id] in the parameters.");r={_id:t._id}}for(let s=0;s<n.length;s++){let o=n[s];if(a.test(o,r))return n[s]=l.merge_objects(o,t),_=!0,e.flush_on_update&&await c(),void i(1)}i(0)}catch(e){s(e)}}))},t.DeleteOne=async function(t){return new Promise((async(r,i)=>{try{let i=0;if(l.value_missing_null_empty(t))n.length>0&&(n.splice(0,1),i++);else for(let e=0;e<n.length;e++){let r=n[e];if(a.test(r,t)){n.splice(e,1),i++;break}}i>0&&(_=!0,e.flush_on_update&&await c()),r(i)}catch(e){i(e)}}))},t.DeleteMany=async function(t){return new Promise((async(r,i)=>{try{let i=0;if(l.value_missing_null_empty(t))i=n.length,n=[];else for(let e=n.length-1;e>=0;e--){let r=n[e];a.test(r,t)&&(n.splice(e,1),i++)}i>0&&(_=!0,e.flush_on_update&&await c()),r(i)}catch(e){i(e)}}))},t}},776:(e,t,n)=>{const r=n(548),i=n(585);t.NewMongoDbProvider=function(e){let t={};async function n(t){let n=null,i=null;try{if(i=await r.MongoClient.connect(e.connection_string,{keepAlive:!0,useUnifiedTopology:!0,useNewUrlParser:!0}),!i)throw new Error("Unable to establish a connection to the mongodb database server.");n=i.db(e.database_name);let a=n.collection(e.collection_name);return await t(a)}catch(e){throw e}finally{i&&i.close()}}return t.WithStorage=n,t.Flush=async function(){return new Promise((async(e,t)=>{e()}))},t.Count=async function(e){return await n((async function(t){return await t.countDocuments(e)}))},t.FindOne=async function(e){return await n((async function(t){return await t.findOne(e)}))},t.FindMany=async function(e){return await n((async function(t){let n=await t.find(e);if(!n)throw new Error("Unable to obtain a cursor on the collection.");return await n.toArray()}))},t.CreateOne=async function(e){return await n((async function(t){if(!(await t.insertOne(e)).acknowledged)throw new Error("Database did not acknowledge insertion.");let n=i.clone(e);return n._id=e._id,n}))},t.WriteOne=async function(e,t){return await n((async function(n){i.value_missing_null_empty(t)&&(t={_id:e._id});let r=i.clone(e);delete r._id;let a=await n.replaceOne(t,r);if(!a.acknowledged)throw new Error("Database did not acknowledge insertion.");return a.modifiedCount}))},t.DeleteOne=async function(e){return await n((async function(t){let n=await t.deleteOne(e);if(!n.acknowledged)throw new Error("Database did not acknowledge deletion.");return n.deletedCount}))},t.DeleteMany=async function(e){return await n((async function(t){let n=await t.deleteMany(e);if(!n.acknowledged)throw new Error("Database did not acknowledge deletion.");return n.deletedCount}))},t}},585:(e,t)=>{function n(e){if(null===e)return!0;switch(typeof e){case"undefined":return!0;case"string":if(0===e.length)return!0;case"object":if(null===e)return!0;if(0===Object.keys(e).length)return!0}return!1}t.value_missing_null_empty=n,t.value_missing=function(e){return null==e},t.value_exists=function(e){return!n(e)},t.MISSING_PARAMETER_ERROR=function(e){return new Error(`Required parameter is missing: ${e}`)},t.READ_ACCESS_ERROR=function(){return new Error("User does not have read access to this object or the object does not exist.")},t.WRITE_ACCESS_ERROR=function(){return new Error("User does not have write access to this object.")},t.clone=function(e){return JSON.parse(JSON.stringify(e))},t.merge_objects=function(e,t){let n=JSON.parse(JSON.stringify(e));return function e(t,n){Object.keys(n).forEach((r=>{let i=n[r];void 0===t[r]?t[r]=JSON.parse(JSON.stringify(i)):"object"==typeof i?e(t[r],i):t[r]=JSON.parse(JSON.stringify(i))}))}(n,t),n},t.zulu_timestamp=function(){return(new Date).toISOString()}},294:e=>{e.exports=require("babel-polyfill")},747:e=>{e.exports=require("fs")},487:e=>{e.exports=require("json-criteria")},973:e=>{e.exports=require("lockfile")},548:e=>{e.exports=require("mongodb")},622:e=>{e.exports=require("path")},191:e=>{e.exports=require("querystring")},231:e=>{e.exports=require("uuid")}},t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={exports:{}};return e[r](i,i.exports,n),i.exports}var r={};return(()=>{var e=r;const t=n(231),i=n(585),a=n(776),s=n(339);e.DefaultConfiguration=function(){return{throw_permission_errors:!1,mongodb:{enabled:!1,collection_name:"Collection-Name",database_name:"Database-Name",connection_string:"mongodb://<username>:<password>@<server-address"},json:{enabled:!1,collection_name:"Collection-Name",database_name:"/path/to/store/collections",flush_on_update:!1,flush_every_ms:0}}},e.NewManagedStorage=function(e={}){let n={},r=null;function o(e){if(i.value_missing_null_empty(e))throw i.MISSING_PARAMETER_ERROR("User");if(i.value_missing_null_empty(e.user_id))throw i.MISSING_PARAMETER_ERROR("User.user_id");if(i.value_missing_null_empty(e.user_role))throw i.MISSING_PARAMETER_ERROR("User.user_role");if(!["admin","super","user"].includes(e.user_role))throw new Error(`Unknown value for User.user_role: [${e.user_role}]`)}function l(e){if(i.value_missing_null_empty(e))throw i.MISSING_PARAMETER_ERROR("ManagedObject");if(i.value_missing_null_empty(e._m))throw i.MISSING_PARAMETER_ERROR("ManagedObject._m");if(i.value_missing_null_empty(e._m.owner_id))throw i.MISSING_PARAMETER_ERROR("ManagedObject._m.owner_id");if(i.value_missing(e._m.readers))throw i.MISSING_PARAMETER_ERROR("ManagedObject._m.readers");if(i.value_missing(e._m.writers))throw i.MISSING_PARAMETER_ERROR("ManagedObject._m.writers");if(i.value_missing(e._m.public))throw i.MISSING_PARAMETER_ERROR("ManagedObject._m.public")}function u(e,t){if(o(e),l(t),"admin"===e.user_role)return!0;if("super"===e.user_role)return!0;if("user"===e.user_role){if(e.user_id===t._m.owner_id)return!0;if(t._m.writers.includes(e.user_id))return!0}return!1}function _(e,t,n){o(e);let r={};return i.value_missing_null_empty(n)||(r._m={id:n}),i.value_missing_null_empty(t)||(r._o=i.clone(t)),"user"===e.user_role&&(r.$or=[],r.$or.push({"_m.owner_id":e.user_id}),r.$or.push({"_m.readers":{$in:e.user_id}}),r.$or.push({"_m.writers":{$in:e.user_id}}),r.$or.push({"_m.public":!0})),r}function c(e){return l(e),{_m:{id:e._m.id}}}return r=e.mongodb&&e.mongodb.enabled?a.NewMongoProvider(e.mongodb):e.json&&e.json.enabled?s.NewJsonProvider(e.json):s.NewJsonProvider(),n.NewManagedObject=function(e,n){if(!i.value_exists(e))throw i.MISSING_PARAMETER_ERROR("Owner");if(!i.value_exists(e.user_id))throw i.MISSING_PARAMETER_ERROR("Owner.user_id");return{_m:{id:t.v4(),created_at:i.zulu_timestamp(),updated_at:i.zulu_timestamp(),owner_id:e.user_id,readers:[],writers:[],public:!1},_o:i.clone(n)}},n.Count=async function(e,t){try{let n=_(e,t,null);return await r.Count(n)}catch(e){throw e}},n.FindOne=async function(e,t){try{let n=null;n="string"==typeof ManagedObjectOrID?c({_m:{id:t}}):_(e,t,null);let i=await r.FindOne(n);return i&&delete i._id,i}catch(e){throw e}},n.FindMany=async function(e,t){try{let n=_(e,t,null),i=await r.FindMany(n);return i.forEach((e=>{delete e._id})),i}catch(e){throw e}},n.CreateOne=async function(e,t){try{let i=n.NewManagedObject(e,t),a=await r.CreateOne(i);return a&&delete a._id,a}catch(e){throw e}},n.WriteOne=async function(t,n){try{l(n);let a=_(t,null,n._m.id),s=await r.FindOne(a);if(!s){if(e.throw_permission_errors)throw i.READ_ACCESS_ERROR();return 0}if(!u(t,s)){if(e.throw_permission_errors)throw i.WRITE_ACCESS_ERROR();return 0}return s._m.updated_at=i.zulu_timestamp(),s._o=i.merge_objects(s._o,n._o),await r.WriteOne(s)}catch(e){throw e}},n.DeleteOne=async function(t,n){try{let a=null;a="string"==typeof ManagedObjectOrID?c({_m:{id:n}}):_(t,Criteria,null);let s=await r.FindOne(a);if(!s){if(e.throw_permission_errors)throw i.READ_ACCESS_ERROR();return 0}if(!u(t,s)){if(e.throw_permission_errors)throw i.WRITE_ACCESS_ERROR();return 0}return await r.DeleteOne(c(s))}catch(e){throw e}},n.DeleteMany=async function(e,t){try{let n=_(e,t,null),i=await r.FindMany(n),a=0;for(let t=0;t<i.length;t++){let n=i[t];if(u(e,n)){if(!await r.DeleteOne(c(n)))throw new Error("There was an unexpected problem deleting the object.");a++}}return a}catch(e){throw e}},n.Share=async function(t,n,a,s,o){try{let d=null;"string"==typeof n?d=c({_m:{id:n}}):(l(n),d=_(t,null,n._m.id));let f=await r.FindOne(d);if(!f){if(e.throw_permission_errors)throw i.READ_ACCESS_ERROR();return 0}if(!u(t,f)){if(e.throw_permission_errors)throw i.WRITE_ACCESS_ERROR();return 0}let m=!1;if(!i.value_missing_null_empty(a)){let e=[];if("string"==typeof a)e.push(a);else{if(!Array.isArray(a))throw new Error("Invalid value for parameter [Readers], must be a string or array of strings.");e=a}e.forEach((e=>{f._m.readers.includes(e)||(f._m.readers.push(e),m=!0)}))}if(!i.value_missing_null_empty(s)){let e=[];if("string"==typeof s)e.push(s);else{if(!Array.isArray(s))throw new Error("Invalid value for parameter [Readers], must be a string or array of strings.");e=s}e.forEach((e=>{f._m.writers.includes(e)||(f._m.writers.push(e),m=!0)}))}return!i.value_missing_null_empty(o)&&o&&(f._m.public||(f._m.public=!0,m=!0)),m?(f._m.updated_at=i.zulu_timestamp(),await r.WriteOne(f)):1}catch(e){throw e}},n.Unshare=async function(t,n,a,s,o){try{let d=null;"string"==typeof n?d=c({_m:{id:n}}):(l(n),d=_(t,null,n._m.id));let f=await r.FindOne(d);if(!f){if(e.throw_permission_errors)throw i.READ_ACCESS_ERROR();return 0}if(!u(t,f)){if(e.throw_permission_errors)throw i.WRITE_ACCESS_ERROR();return 0}let m=!1;if(!i.value_missing_null_empty(a)){let e=[];if("string"==typeof a)e.push(a);else{if(!Array.isArray(Readers))throw new Error("Invalid value for parameter [Readers], must be a string or array of strings.");e=a}e.forEach((e=>{let t=f._m.readers.indexOf(e);t>=0&&(f._m.readers.slice(t,1),m=!0)}))}if(!i.value_missing_null_empty(s)){let e=[];if("string"==typeof s)e.push(s);else{if(!Array.isArray(s))throw new Error("Invalid value for parameter [Readers], must be a string or array of strings.");e=s}e.forEach((e=>{let t=f._m.writers.indexOf(e);t>=0&&(f._m.writers.slice(t,1),m=!0)}))}return!i.value_missing_null_empty(o)&&o&&f._m.public&&(f._m.public=!1,m=!0),m?(f._m.updated_at=i.zulu_timestamp(),await r.WriteOne(f)):1}catch(e){throw e}},n.SystemAdministrator={name:"System Administrator",user_id:"admin@system",user_role:"admin"},n}})(),r})()}));